<!DOCTYPE html>
<html>
<head>  
  <title>ğŸ“º Remote Screen Viewer</title>
</head>
<body>
  <h1>Remote Screen Viewer</h1>
  <video id="remoteVideo"  autoplay playsinline controls style="width: 50%;"></video>
  <button id="stopScreenBtn" disabled>ï¿½ï¿½ï¸ Pause Screen Share</button>
  <button id="resumeScreenBtn" disabled>â–¶ï¸ Resume Screen Share</button>
  <video id="remoteWebcam" autoplay playsinline controls style="width: 50%;"></video>
  <audio id="mic_audio" autoplay controls playsinline></audio>
  <pre id="log" style="background: #eee; padding: 10px;"></pre>

  <br />
  <button id="connectBtn">ğŸ”Œ Connect to Stream</button>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io("http://localhost:3000");
    const screenVideo = document.getElementById("remoteVideo");
    
    const webcamVideo = document.getElementById("remoteWebcam");
    const micAudio = document.getElementById("mic_audio");
    const connectBtn = document.getElementById("connectBtn");
    const stopScreenBtn = document.getElementById("stopScreenBtn")
    const resumeScreenBtn = document.getElementById("resumeScreenBtn");

    const pc = new RTCPeerConnection();
    let screenSet = false, webcamSet = false, dataChannelSet = false;
    let screenSource = null;

    window.addEventListener("mousemove", (event) => {
      if (dataChannelSet) {
        const x = event.screenX;
        const y = event.screenY;
        // console.log(`Mouse position: X=${x}, Y=${y}`);
        dataChannel.send(`Mouse position: X=${x}, Y=${y}`);
      }
    });

    stopScreenBtn.onclick = () => {
    console.log("ğŸ–¥ï¸ Disconnecting from screen share");
    stopScreenBtn.disabled = true;
    socket.emit("stop_screen"); // Clear the screen video
    };

    resumeScreenBtn.onclick = () => {
        console.log("â–¶ï¸ Resuming screen share");
        socket.emit("resume_screen");
        resumeScreenBtn.disabled = true;
    };

    socket.on("screen_stopped", () => {
    console.log("ğŸ–¥ï¸ Screen share stopped by sender");
    screenVideo.srcObject = null;
    resumeScreenBtn.disabled = false;
    });

    socket.on("screen_resumed", () => {
        console.log("â–¶ï¸ Screen share resumed by sender");
        stopScreenBtn.disabled = false;
        screenVideo.srcObject = screenSource;
    });

    socket.on("connect", () => {
      console.log("âœ… Viewer connected to Socket.IO");
      socket.emit("viewer");
    });
    
    console.log(connectBtn)
    connectBtn.onclick = () => {
      console.log("ğŸš€ Requesting stream start");
      socket.emit("start");
      connectBtn.disabled = true;
      connectBtn.textContent = "Connecting...";
    };

    screenVideo.onloadeddata = () => {
      console.log("âœ… Video data loaded â€“ stream established");
      connectBtn.disabled = false;
      stopScreenBtn.disabled = false; // Enable stop screen button
      connectBtn.textContent = "ğŸ”´ Disconnect";
      connectBtn.onclick = () => {
        console.log("ğŸ”´ Disconnecting from stream");
        socket.emit("stop");
        connectBtn.disabled = true;
        connectBtn.textContent = "Disconnecting...";
      };
    };

    socket.on("offer", async (offer) => {
      console.log("ğŸ“© Got offer", offer);
      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit("answer", pc.localDescription);
      console.log("âœ… Sent answer");
    });

    socket.on("stopped-sending", () => {
      console.log("ğŸ”´ Stream stopped");
      connectBtn.disabled = false;
      screenVideo.srcObject = null;
      webcamVideo.srcObject = null;
      connectBtn.textContent = "ğŸ”Œ Connect to Stream";
      connectBtn.onclick = () => {
      console.log("ğŸš€ Requesting stream start");
      socket.emit("start");
      connectBtn.disabled = true;
      connectBtn.textContent = "Connecting...";
    };
    });

    socket.on("ice", (candidate) => {
      console.log("ğŸŒ Got ICE candidate", candidate);
      pc.addIceCandidate(candidate);
    });

    pc.ontrack = (event) => {
      console.log("ğŸ¥ Got track:", event.track.kind, event.track.id);
      if (event.track.kind === "video") {
        if (!screenVideo.srcObject) {
          screenSource = new MediaStream([event.track]);
          screenVideo.srcObject = screenSource;
        } else if (!webcamVideo.srcObject) {
          webcamVideo.srcObject = new MediaStream([event.track]);
        }
      }
      if (event.track.kind === "audio") {
        console.log("ğŸ¤ Got audio track");
        micAudio.srcObject = new MediaStream([event.track]);
      }
    };

    pc.ondatachannel = (event) => {
      dataChannel = event.channel;
      dataChannelSet = true;
      dataChannel.onopen = () => {
        console.log("âœ… Data channel open");
        dataChannel.send("ğŸ‘‹ Hello from browser");
      };

      dataChannel.onmessage = (e) => {
        console.log("ğŸ“¨ Message from Python:", e.data);
        document.getElementById("log").textContent += `\n${e.data}`;
      };
    };
  </script>
</body>
</html>
